<%= render partial: 'aypex/admin/shared/order_tabs', locals: { current: :customer_returns } %>

<% content_for :page_title do %>
  / <%= Aypex.t(:reimbursement) %> #<%= @reimbursement.number %>
<% end %>

<%= render partial: 'aypex/admin/shared/error_messages', locals: { target: @reimbursement } %>

<%= form_with model: [:admin, @order, @reimbursement] do |f| %>
  <fieldset class='no-border-bottom'>
    <legend><%= Aypex.t(:items_to_be_reimbursed) %></legend>
    <div class="table-responsive border rounded">
      <table class="table table-condensed border rounded reimbursement-return-items-table">
        <thead class="text-muted">
          <tr>
            <th><%= Aypex.t(:product) %></th>
            <th><%= Aypex.t(:preferred_reimbursement_type) %></th>
            <th><%= Aypex.t(:reimbursement_type_override) %></th>
            <th><%= Aypex.t(:pre_tax_refund_amount) %></th>
            <th><%= Aypex.t(:total) %></th>
            <th><%= Aypex.t(:exchange_for) %></th>
          </tr>
        </thead>
        <tbody>
          <%= f.fields_for :return_items, @reimbursement.return_items.sort_by(&:id) do |item_fields| %>
            <% return_item = item_fields.object %>
            <tr>
              <td>
                <div class="variant-name">
                  <%= link_to return_item.inventory_unit.variant.name, aypex.edit_admin_product_path(return_item.inventory_unit.variant.product) %>
                </div>
                <div class="variant-options"><%= return_item.inventory_unit.variant.options_text %></div>
              </td>
              <td>
                <%= reimbursement_type_name(return_item.preferred_reimbursement_type) %>
              </td>
              <td>
                <%= item_fields.select(:override_reimbursement_type_id,
                  reimbursement_types.collect { |r| [r.name.humanize, r.id] },
                  {include_blank: true},
                  {data: {controller: 'ts--select'}}
                ) %>
              </td>
              <td>
                <%= item_fields.text_field :pre_tax_amount, { class: 'refund-amount-input form-control' } %>
              </td>
              <td>
                <%= return_item.display_total %>
              </td>
              <td>
                <% if return_item.exchange_processed? %>
                  <%= return_item.exchange_variant.exchange_name %>
                <% else %>
                  <%= item_fields.collection_select :exchange_variant_id, return_item.eligible_exchange_variants, :id, :exchange_name, { include_blank: true }, { class: "return-item-exchange-selection", data: {controller: 'ts--select'} } %>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </fieldset>

  <div class="form-actions filter-actions actions" data-hook="buttons">
    <%= button I18n.t('aypex.admin.actions.update'), 'update' %>
  </div>
<% end %>

<fieldset class="mt-3">
  <legend><%= Aypex.t(:calculated_reimbursements) %></legend>
  <div class="table-responsive border rounded">
    <table class="table table-condensed border rounded">
      <thead data-hook="customer_return_header">
        <tr>
          <th><%= Aypex.t(:reimbursement_type) %></th>
          <th><%= Aypex.t(:description) %></th>
          <th><%= Aypex.t(:amount) %></th>
        </tr>
      </thead>
      <tbody>
        <% @reimbursement_objects.each do |reimbursement_object| %>
          <tr data-hook="reimbursement_reimbursement_object_row">
            <td><%= reimbursement_object.class.name.demodulize %></td>
            <td><%= reimbursement_object.description %></td>
            <td><%= reimbursement_object.display_amount %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
  <% if @order.has_non_reimbursement_related_refunds? %>
    <div class="alert alert-danger">
      <%= "#{I18n.t('aypex.admin.note')}: #{I18n.t('aypex.admin.this_order_has_already_received_a_refund')}. #{I18n.t('aypex.admin.make_sure_the_above_reimbursement_amount_is_correct')}." %>
    </div>
  <% end %>
  <div class="form-actions" data-hook="reimburse-buttons">
    <% if !@reimbursement.reimbursed? %>
      <%= button_to [:perform, :admin, @order, @reimbursement], { class: 'btn btn-primary ', method: 'post' } do %>
        <span class="icon icon-save"></span>
        <%= Aypex.t(:reimburse) %>
      <% end %>
      <span class="or"><%= Aypex.t(:or) %></span>
      <%= link_to_with_icon I18n.t('aypex.admin.actions.cancel'), aypex.edit_admin_order_customer_return_path(@order, @reimbursement.customer_return), icon: 'cancel' %>
    <% end %>
  </div>
</fieldset>
